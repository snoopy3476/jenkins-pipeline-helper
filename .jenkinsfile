// Demo cycle JenkinsFile for Tmax CI/CD

podTemplate(label: 'jenkins-slave-pod', 
	image: 'jenkins/jnlp-agent-docker',
	containers: [
		containerTemplate(
			name: 'docker',
			image: 'docker',
			command: 'cat',
			ttyEnabled: true
		),
	],
	volumes: [ 
		hostPathVolume(mountPath: '/var/run/docker.sock', hostPath: '/var/run/docker.sock'), 
	]) {



	node('jenkins-slave-pod') {


		// notify pending stages
		gitlabBuilds(builds: ['01-build', '02-test', '03-push']) {



			container('docker') {
				// build stage
				stage('01-build') {

					sleep 10

					echo 'Notify to GitLab - build stage running'
					updateGitlabCommitStatus name: '01-build', state: 'running'

					echo '- Build'
					sleep 10
					sh 'docker --help'
					sh 'touch tmplog; cat tmplog; echo "A" > tmplog'
					echo '+ Build!'

					echo 'Notify to GitLab - build stage success'
					updateGitlabCommitStatus name: '01-build', state: 'success'

					sh 'touch tmplog; cat tmplog; echo "B" > tmplog'
				}

				// test stage
				stage('02-test') {

					docker.image('docker').inside {

						echo 'Notify to GitLab - test stage running'
						updateGitlabCommitStatus name: '02-test', state: 'running'

						echo '- Test'
						sleep 10
						sh 'touch tmplog; cat tmplog; echo "C" > tmplog'

						echo 'Notify to GitLab - test stage success'
						updateGitlabCommitStatus name: '02-test', state: 'success'
					}
					
					docker.image('docker').inside {
						sh 'touch tmplog; cat tmplog; echo "D" > tmplog'
					}

				}

				// pull stage
				stage('03-push') {
					echo 'Notify to GitLab - push stage running'
					updateGitlabCommitStatus name: '03-push', state: 'running'

					echo '- Push'
					sleep 10

					echo 'Notify to GitLab - push stage success'
					updateGitlabCommitStatus name: '03-push', state: 'success'
				}
			}




		}


	}
}
